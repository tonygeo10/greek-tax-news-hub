<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greek Tax News Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- App content will be dynamically inserted here -->
    </div>

    <script>
        class NewsHub {
            constructor() {
                this.feeds = new Map();
                this.articles = [];
                this.currentPage = 1;
                this.pageSize = 20;
                this.totalPages = 1;
                this.isLoading = false;
                this.retryDelay = 1000;
                this.maxRetries = 3;

                // Initialize with error handling
                this.init().catch(console.error);
            }

            /**
             * Initialize the application
             * @returns {Promise<void>}
             */
            async init() {
                try {
                    await this.loadFeeds();
                    await this.loadArticles();
                    this.setupEventListeners();
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.showNotification('Σφάλμα αρχικοποίησης', 'error');
                }
            }

            /**
             * Load feeds with retry mechanism
             * @returns {Promise<void>}
             */
            async loadFeeds(retryCount = 0) {
                try {
                    const response = await fetch('/api/feeds');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const feeds = await response.json();
                    feeds.forEach(feed => this.feeds.set(feed.FeedID, feed));
                } catch (error) {
                    if (retryCount < this.maxRetries) {
                        await new Promise(resolve => 
                            setTimeout(resolve, this.retryDelay * Math.pow(2, retryCount))
                        );
                        return this.loadFeeds(retryCount + 1);
                    }
                    throw error;
                }
            }

            /**
             * Load articles with pagination
             * @param {number} page - Page number
             * @returns {Promise<void>}
             */
            async loadArticles(page = 1) {
                try {
                    this.isLoading = true;
                    const response = await fetch(`/api/aade-news?page=${page}&pageSize=${this.pageSize}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.articles = data.articles;
                    this.currentPage = page;
                    this.totalPages = data.pagination.totalPages;

                    this.renderArticles();
                } catch (error) {
                    console.error('Failed to load articles:', error);
                    this.showNotification('Σφάλμα φόρτωσης άρθρων', 'error');
                } finally {
                    this.isLoading = false;
                }
            }

            /**
             * Render articles with proper date formatting
             */
            renderArticles() {
                const container = document.getElementById('app');
                if (!this.articles.length) {
                    container.innerHTML = `
                        <div class="text-center py-10">
                            <p class="text-gray-500">Δεν βρέθηκαν άρθρα</p>
                        </div>
                    `;
                    return;
                }

                const articlesHtml = this.articles.map(article => `
                    <article class="bg-white rounded-lg shadow-md p-6 mb-4">
                        <h2 class="text-xl font-semibold mb-2">
                            <a href="${article.link}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                ${this.escapeHtml(article.title)}
                            </a>
                        </h2>
                        <p class="text-gray-600 mb-4">${this.escapeHtml(article.description)}</p>
                        <div class="text-sm text-gray-500">
                            ${this.formatDate(article.pubDate)}
                        </div>
                    </article>
                `).join('');

                container.innerHTML = `
                    ${articlesHtml}
                    ${this.renderPagination()}
                `;
            }

            /**
             * Render pagination controls
             * @returns {string} Pagination HTML
             */
            renderPagination() {
                if (this.totalPages <= 1) return '';

                const pages = [];
                for (let i = 1; i <= this.totalPages; i++) {
                    if (
                        i === 1 ||
                        i === this.totalPages ||
                        (i >= this.currentPage - 2 && i <= this.currentPage + 2)
                    ) {
                        pages.push(i);
                    } else if (pages[pages.length - 1] !== '...') {
                        pages.push('...');
                    }
                }

                const paginationHtml = pages.map(page => {
                    if (page === '...') {
                        return '<span class="px-3 py-2">...</span>';
                    }
                    return `
                        <button
                            class="px-3 py-2 ${page === this.currentPage
                                ? 'bg-blue-600 text-white'
                                : 'text-blue-600 hover:bg-blue-100'} rounded"
                            ${page === this.currentPage ? 'disabled' : ''}
                            onclick="app.loadArticles(${page})"
                        >
                            ${page}
                        </button>
                    `;
                }).join('');

                return `
                    <div class="flex justify-center space-x-2 mt-6">
                        ${paginationHtml}
                    </div>
                `;
            }

            /**
             * Format date for display
             * @param {string} dateString - ISO date string
             * @returns {string} Formatted date
             */
            formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        throw new Error('Invalid date');
                    }
                    return new Intl.DateTimeFormat('el', {
                        dateStyle: 'full',
                        timeStyle: 'short'
                    }).format(date);
                } catch (error) {
                    console.warn('Date formatting failed:', error);
                    return dateString;
                }
            }

            /**
             * Escape HTML to prevent XSS
             * @param {string} str - String to escape
             * @returns {string} Escaped string
             */
            escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            /**
             * Show notification to user
             * @param {string} message - Message to show
             * @param {string} type - Notification type
             */
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg ${
                    this.getNotificationClass(type)
                }`;
                notification.textContent = message;

                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 5000);
            }

            /**
             * Get notification CSS class
             * @param {string} type - Notification type
             * @returns {string} CSS class
             */
            getNotificationClass(type) {
                const classes = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    warning: 'bg-yellow-500 text-white',
                    info: 'bg-blue-500 text-white'
                };
                return classes[type] || classes.info;
            }
        }

        // Initialize the application
        const app = new NewsHub();
    </script>
</body>
</html>
